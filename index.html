<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Token Factory</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: white;
    }

    header {
      width: 100%;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(6px);
      z-index: 100;
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #ff0000;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      border-radius: 6px;
      transition: 0.2s;
    }

    .btn-primary {
      background: #ff0000;
      color: white;
    }
    .btn-primary:hover { 
      background: #cc0000;
      transform: scale(1.05);
    }

    .btn-error {
      background: #444;
      color: #ff0000;
      border: 1px solid #ff0000;
    }
    .btn-error:hover { 
      background: #770000;
      transform: scale(1.05);
    }

    .main {
      margin-top: 150px;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 50px;
      color: #ff0000;
    }

    p {
      font-size: 20px;
      margin-top: -10px;
      color: #ccc;
    }

    #notif {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #111;
      border-left: 5px solid #ff0000;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      opacity: 0;
      transform: translateY(-20px);
      transition: 0.3s ease;
      z-index: 200;
      font-size: 16px;
      pointer-events: none;
    }
    #notif.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* MODAL */
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 300;
    }
    #modalContent {
      background: #111;
      padding: 25px;
      border-radius: 10px;
      width: 350px;
      text-align: left;
      border: 1px solid #ff0000;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
      color: white;
    }
  </style>

  <!-- Solana Web3 -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest"></script>
</head>

<body>

  <!-- NOTIFICACI√ìN -->
  <div id="notif"></div>

  <!-- MODAL -->
  <div id="modal">
    <div id="modalContent">
      <h2>Crear Token</h2>

      <label>Nombre del token</label>
      <input id="tokenName" placeholder="Ej: RoadCoin" />

      <label>S√≠mbolo</label>
      <input id="tokenSymbol" placeholder="Ej: RDC" />

      <label>Supply</label>
      <input id="tokenSupply" type="number" placeholder="Ej: 1000000" />

      <button class="btn btn-primary" style="margin-top:15px;width:100%;" onclick="startTokenCreation()">
        Pagar 0.058 SOL y crear token
      </button>

      <button class="btn btn-error" style="margin-top:10px;width:100%;" onclick="closeModal()">
        Cancelar
      </button>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="logo">TOKEN FACTORY</div>

    <button 
      id="walletBtn"
      class="btn btn-primary"
      onclick="connectWallet()"
    >
      Conectar wallet
    </button>
  </header>

  <!-- CONTENIDO -->
  <div class="main">
    <h1>Crea tokens en Solana</h1>
    <p>Simple, r√°pido y en mainnet</p>

    <button 
      class="btn btn-primary"
      onclick="openModal()"
      style="margin-top:30px"
    >
      Crear token
    </button>
  </div>

  <!-- SCRIPT -->
  <script>
    let walletConnected = false;
    let walletAddress = "";
    const TOKEN_CREATION_PRICE = 0.058; // SOL
    const ADMIN_WALLET = "H1mn89WUyB55iGWFhCFrL5PP7KjniG5JT3beCsMwVHHv";

    const connection = new solanaWeb3.Connection(
      "https://api.mainnet-beta.solana.com",
      "confirmed"
    );

    function showNotif(msg) {
      const n = document.getElementById('notif');
      n.innerText = msg;
      n.classList.add("show");
      setTimeout(() => n.classList.remove("show"), 2500);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const provider = window.solana;
      if (provider && provider.isPhantom) {
        try {
          const resp = await provider.connect({ onlyIfTrusted: true });
          if (resp.publicKey) {
            walletConnected = true;
            walletAddress = resp.publicKey.toString();
            updateWalletButton();
            showNotif("‚úÖ Wallet conectada autom√°ticamente");
          }
        } catch {}
      }
    });

    function updateWalletButton() {
      const btn = document.getElementById("walletBtn");
      if (walletConnected) {
        const shortAddr = walletAddress.slice(0,6) + "..." + walletAddress.slice(-4);
        btn.innerText = shortAddr;
        btn.classList.remove("btn-primary");
        btn.classList.add("btn-error");
      } else {
        btn.innerText = "Conectar wallet";
        btn.classList.remove("btn-error");
        btn.classList.add("btn-primary");
      }
    }

    async function connectWallet() {
      const provider = window.solana;
      if (!provider || !provider.isPhantom) {
        showNotif("Instala Phantom para continuar");
        return;
      }

      try {
        if (!walletConnected) {
          const resp = await provider.connect();
          walletConnected = true;
          walletAddress = resp.publicKey.toString();
          updateWalletButton();
          showNotif("üü¢ Wallet conectada");
        } else {
          await provider.disconnect();
          walletConnected = false;
          walletAddress = "";
          updateWalletButton();
          showNotif("üîå Wallet desconectada");
        }
      } catch (err) {
        showNotif("‚ö†Ô∏è Error: " + (err.message || err));
      }
    }

    function openModal() {
      if (!walletConnected) return showNotif("Conecta tu wallet primero");
      document.getElementById("modal").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    // COBRAR AL USUARIO
    async function chargeUser() {
      const provider = window.solana;
      const lamports = TOKEN_CREATION_PRICE * 1e9;

      const transaction = new solanaWeb3.Transaction().add(
        solanaWeb3.SystemProgram.transfer({
          fromPubkey: provider.publicKey,
          toPubkey: new solanaWeb3.PublicKey(ADMIN_WALLET),
          lamports
        })
      );

      const signed = await provider.signTransaction(transaction);
      const signature = await connection.sendRawTransaction(signed.serialize());
      await connection.confirmTransaction(signature, "confirmed");

      return signature;
    }

    // CREAR TOKEN
    async function createToken(name, symbol, supply) {
      const provider = window.solana;

      // Owner
      const payer = provider.publicKey;

      // Crear mint
      const mint = await splToken.createMint(
        connection,
        payer,
        payer,
        null,
        9
      );

      // Crear cuenta asociada
      const ata = await splToken.getOrCreateAssociatedTokenAccount(
        connection,
        payer,
        mint,
        payer
      );

      // Mint supply
      await splToken.mintTo(
        connection,
        payer,
        mint,
        ata.address,
        payer,
        supply * 1e9
      );

      return mint.toString();
    }

    async function startTokenCreation() {
      const name = document.getElementById("tokenName").value.trim();
      const symbol = document.getElementById("tokenSymbol").value.trim();
      const supply = parseInt(document.getElementById("tokenSupply").value);

      if (!name || !symbol || !supply) {
        return showNotif("Completa todos los campos");
      }

      try {
        showNotif("üí∞ Procesando pago...");
        await chargeUser();

        showNotif("üõ† Creando token...");
        const mintAddress = await createToken(name, symbol, supply);

        showNotif("üéâ Token creado: " + mintAddress);
        closeModal();

      } catch (err) {
        console.error(err);
        showNotif("Error: " + err.message);
      }
    }
  </script>

</body>
</html>
